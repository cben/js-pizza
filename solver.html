<html>
<head>

	<script data-main="solver" type="text/javascript" src="lib/require.js"></script>
    <script type="text/javascript"  >
    require(["solver"], function(solver) {
        var names = ["yuval","gadi"];
        var toppings = ["mushroom","onion"];
        var amounts = {"yuval":[4,8], "gadi":[4,8]};
        var modulo = 4;
        var all_edible = [["yuval", "mushroom"], ["gadi", "mushroom"], ["yuval", "onion"]];
        
        var r = solver.solve(names, toppings, amounts, modulo, all_edible);
        var s = ""
        for (ind in r) {
            res = r[ind];
            for (k in res) {
                s += k + ":" + res[k] + "; "   
            }
            s += "\n";    
        }
    //    alert("r:\n" + s ); 
    });
    
    </script>
    
    
<script  type="text/javascript" >
var names = ["yuval","gadi"];
var toppings = ["mushroom","onion"];
         // Feature test (http://mathiasbynens.be/notes/localstorage-pattern)
var hasStorage = (function() {
      try {
        var mod = "testlocalstoragefeature"
        localStorage.setItem(mod, mod);
        localStorage.removeItem(mod);
        return true;
      } catch(e) {
        return false;
      }
}());


function save() {
    if(hasStorage) {
        // save all inputs
        var allInputs = document.getElementsByTagName("input");
        values = {};
        for (i = 0; i < allInputs.length; i++) {
          var inp = allInputs[i];
          if (inp.type == "checkbox") {
              values[inp.id] = inp.checked;
          } else {
              values[inp.id] = inp.value;
          }
        }
        
        locaulStorage.setItem('values', JSON.stringify(values));
    }
}
  
function getValues() {
    var values = {};
    if(hasStorage) {
        var ser = localStorage.getItem("values");
        if (ser) {
             values =  JSON.parse(ser);
        }
    }
    return values;
}

function createRow(name) {
    var values = getValues();
    s = "";
    s += "<td>" + name + "</td>";
    var mnt  = "0";
    var mntId = "amnt_"+names[ind];
    if (values && values[mntId]) {
      mnt = values[mntId]
    }
    s += '<td><input type="number" id="' + mntId + '" min="0" value="'+mnt+'"></td>';
    
    for (tind in toppings) {
        var checked = "";
        var chId = "nt_" + names[ind] + ";" + toppings[tind] ;
        if (values && values[chId]) {
            checked = values[chId] ? "checked" : "";
        }
        s+= "<td><input type='checkbox' id='" +chId+ "' " + checked + "/> </td>";
    }
    return s;
}

function getAllEatable () {
    alleatable = []
    for (ind in names) {
        var name = names[ind];
        for (tind in toppings) {
           var top  = toppings[tind];
           var checkBox = document.getElementById("nt_"+name+";"+top);
           if (checkBox && checkBox.checked) {
               alleatable.push([name, top]) 
           }
        }
    }
    return alleatable ;
}

function getAmounts () {
    amounts = {}
    for (ind in names) {
        var name = names[ind];
        var inp = document.getElementById("amnt_"+name);
        amounts[name] =  [parseInt(inp.value)];
    }
    return amounts;
}


function getSlicesFromRes(res){
    var slices = {};
    for (ind2 in res) {
        var record = res[ind2];
        k = record[0];
        var name = k[0];
        var topping = k[1];
        amnt = record[1];
        
        if (slices[topping]) {
            slices[topping] += amnt;
        } else {
            slices[topping] = amnt;
        }
        
    }
    return slices;
}

function putInRecords(records, slices, record) {
    // now the slices is full!
    // save the all the records that lead to the same slices in the same place.
   for (i = 0; i < records.length; ++i) {
        sl = records[i][0];
        var wasFound = true;
        for (k in sl) {
            if (sl[k] != slices[k]) {
                wasFound = false;
                break;
            }
        }
        if (wasFound) {
            records[i][1].push(record);
            return true;
        }
    }
    // not found, push it clean..
    records.push([slices, [res]]);
    return false;
}

function calc() {
    
    var amounts = getAmounts();
    var all_edible = getAllEatable();
    var modulo = 4;
    
   require(["solver"], function(solver) {

        var r = solver.solve(names, toppings, amounts, modulo, all_edible);
        var records = [];
        for (ind in r) {
            res = r[ind];
            slices = getSlicesFromRes(res);
            putInRecords(records, slices, res);
        }
    
        var report = generateReport(records);
      
        document.getElementById("results").innerHTML =  report;
        save();      
        return records;
   });    
 }  
 function generateReport(records) {
    var report = "";
    for (ind in records) {
    slices = records[ind][0];
    var p = "";
    for (i = 0; i < toppings.length; ++i) {
        var topping = toppings[i];
        if (slices[topping]) {
            p += topping + ": " + slices[topping]; 
        } else {
            p += topping + ": " + 0;
        }
        p += " ";
    }
    
    var s = ""
    for(indr in records[ind][1]) {
        res =  records[ind][1][indr];
        for (indres in res) {
            var record = res[indres];
            k = record[0];
            var name = k[0];
            var topping = k[1];
            amnt = record[1];
            s += k + ":" + amnt + "; "   
        }
        s += "<br/>\n";
    }
    
    report = report + "<details><summary>" + p + "</summary>" + s + "</details>";
    }
    return report;
}
</script>
    
</head>
<body>
<table id="data">
<tr>
<th>Name</th>
<th>Amount</th>
    <script  type="text/javascript" >
    for (ind in toppings) {
        document.write("<th>" + toppings[ind] + "</th>");
    }
    </script>
</tr>
    <script  type="text/javascript" >
    for (ind in names) {
        document.write("<tr>" + createRow(names[ind]) + "</tr>");
    }
    </script>

</table>

<button onclick="javascript:calc();">calc</button>
<div id="results">
</div>

</body>

</html>
