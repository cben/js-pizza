<html>
<head>
<link href='http://fonts.googleapis.com/css?family=Ubuntu' rel='stylesheet' type='text/css'>
<style>
.tablerow:hover {
    background-color: rgba(255, 255, 140, 0.7);
}

.tablerow {
    -webkit-transition: background .5s;
    -moz-transition: background .5s;
    transition: background .5s;
}

html {
    font-family: 'Ubuntu', sans-serif;
}

button {
    background: rgba(0,0,0,0);
    border-color: rgba(0,0,0,0);
    -webkit-transition: background .5s;
    -moz-transition: background .5s;
    transition: background .5s;
    border-radius : 1em;
}
button:hover {
    border-color: #fff;
}

button:hover.add {
    background: rgb(0,255,0);
}

button:hover.remove {
    background: rgb(255,0,0);
}

</style>
<script data-main="solver" type="text/javascript" src="lib/require.js"></script>
  
<script  type="text/javascript" >
// Edit these two variables:
var names = ["Alice","Bob"];
var toppings = ["Regular", "Mushrooms","Onion", "Olives"];
// a topping must be on at least this much slices (usually, half a pizza =4)
var MIN_SLICES_FOR_TOPPING = 4;


///////////////////////////////////////////////////////////////////////////////////////////////
// Feature test (http://mathiasbynens.be/notes/localstorage-pattern)
var hasStorage = (function() {
      try {
        var mod = "testlocalstoragefeature";
        localStorage.setItem(mod, mod);
        localStorage.removeItem(mod);
        return true;
      } catch(e) {
        return false;
      }
}());


function save() {
    if(hasStorage) {
        // save all inputs
        var allInputs = document.getElementsByTagName("input");
        values = {};
        for (i = 0; i < allInputs.length; i++) {
          var inp = allInputs[i];
          if (inp.type == "checkbox") {
              values[inp.id] = inp.checked;
          } else {
              values[inp.id] = inp.value;
          }
        }
        
        values["names"] = names;
        values["toppings"] = toppings;

        localStorage.setItem('values', JSON.stringify(values));
    }
}

function getValues() {
    var values = {};
    if(hasStorage) {
        var ser = localStorage.getItem("values");
        if (ser) {
             values =  JSON.parse(ser);
        }
    }
    return values;
}

function createRow(name) {
    var values = getValues();
    s = "";
    
    var index = names.indexOf(name);
    removeString = "";
    if (index >= 0)
        removeString = '<button class="remove" onclick="removeName(' + index + ')" >-</button>'
    
    
    s += "<td>" + removeString  + name + "</td>";
    
    
    var mnt  = "0";
    var mntId = "amnt_"+name;
    if (values && values[mntId]) {
      mnt = values[mntId]
    }
    
    s += '<td><input maxlength="2" type="number" onchange="javascript:calc();" id="' + mntId + '" min="0" max="99" value="'+mnt+'"></td>';

    for (tind in toppings) {
        var checked = "";
        var chId = "nt_" + name + ";" + toppings[tind] ;
        if (values && values[chId]) {
            checked = values[chId] ? "checked" : "";
        }
        s+= "<td class='topping-select-cell'><input type='checkbox' onchange='javascript:calc();'  id='" +chId+ "' " + checked + "/> </td>";
    }
    return s;
}

function getAllEatable () {
    alleatable = []
    for (ind in names) {
        var name = names[ind];
        for (tind in toppings) {
           var top  = toppings[tind];
           var checkBox = document.getElementById("nt_"+name+";"+top);
           if (checkBox && checkBox.checked) {
               alleatable.push([name, top]);
           }
        }
    }
    return alleatable ;
}

function getAmounts () {
    amounts = {};
    for (ind in names) {
        var name = names[ind];
        var inp = document.getElementById("amnt_"+name);
        amounts[name] =  [parseInt(inp.value)];
    }
    return amounts;
}


function calc() {

    var amounts = getAmounts();
    var all_edible = getAllEatable();
    var modulo = MIN_SLICES_FOR_TOPPING;

    require(["solver"], function(solver) {
    
       var report = "";
       try {
           records = solver.parseToRecords(solver.solve(names, toppings, amounts, modulo, all_edible));
           generateReport(records);
        } catch (err) {            
            generateReportError(err);
        }
       save();
    });
}
 
function expectancy(list) {
    var sum = 0;
    for (i = 0; i < list.length;i++)
    {   
        sum += list[i];
    }
    return sum / list.length;  
}

function variance(list) {
    
    var squareL = [];
    for (i = 0; i < list.length;i++)
    {
        squareL.push(list[i] * list[i]);
    }
    var avg = expectancy(list);
    return expectancy(squareL) - (avg * avg);
}

function getVariance(record) {
    // we only care about values:
    values = [];
    for (k in record) {
        values.push(record[k]);
    }
    return variance(values);
}

function generateReport(records) {
    report = doReport(records);
    document.getElementById("results").innerHTML =  report;    
}

function generateReportError(err) {
    report = "Error: " + err.message;
    document.getElementById("results").innerHTML =  report;    
}
            

function doReport(records) {
    var report = "";
    
    // sort records by variance, so we get the most diverse pizza first.
    // (the one that the number of slizes per topping is closest to the average)
    records.sort(function(a,b){return getVariance(a[0])-getVariance(b[0])});
    
    for (ind in records) {
    slices = records[ind][0];
    var p = "";
    for (i = 0; i < toppings.length; ++i) {
        var topping = toppings[i];
        if (slices[topping]) {
            p += topping + ": " + slices[topping];
        } else {
            p += topping + ": " + 0;
        }
        p += " ";
    }
    // p +=  "(" + getVariance(slices) +")";
    var s = "";
    for(indr in records[ind][1]) {
        res =  records[ind][1][indr];
        for (indres in res) {
            var record = res[indres];
            k = record[0];
            var name = k[0];
            var topping = k[1];
            amnt = record[1];
            s += k + ":" + amnt + "; ";
        }
        s += "<br/>\n";
    }

    report = report + "<li><div><details><summary>" + p + "</summary><div>" + s + "</div></details></div></li>";
    }
    return "<ul>" + report + "</ul>";
}
</script>

<script  type="text/javascript" >
// init names

function restoreValues() {
    values = getValues();
    var tmp = values["names"];
    if (tmp) {
        names = tmp;
    }
    tmp = values["toppings"];
    if (tmp) {
        toppings = tmp;
    }
}

restoreValues();

function addName(name) {
    names.push(name);
    var table = document.getElementById("data").tBodies[0];
    var row = table.insertRow(table.rows.length);
    row.className = "tablerow";
    row.innerHTML = createRow(name);
}

function promptName() {
     var name = prompt("Add name");
     if (name) {
         addName(name);
         save();
     }
}


function addTopping(topp) {
    toppings.push(topp);
    var table = document.getElementById("data");
    
    var toppingHeader = document.createElement('th');
    	toppingHeader.appendChild(document.createTextNode(topp));
    	theadRow = table.tHead.rows[0];
    	// the last element is the + button
    	theadRow.insertBefore(toppingHeader, theadRow.children[theadRow.children.length-1]);

	var nameRows = table.tBodies[0];
	for (var i = 0; i <  nameRows.rows.length; i++) {
		var newCell = nameRows.rows[i].insertCell(-1);
		
        var chId = "nt_" + names[i] + ";" + topp ;
		newCell.innerHTML = "<input type='checkbox' onchange='javascript:calc();'  id='" +chId+ "' />";
	}
}

function promptTopping() {
     var topp = prompt("Add topping");
     if (topp) {
         addTopping(topp);
         save();
     }
}

function removeName(index) {
    names.splice(index, 1);
    var table = document.getElementById("data").tBodies[0];
    table.deleteRow(index);
    save();
	calc();
}

function removeTopp(index) {
    toppings.splice(index, 1);
    var CELL_PPREFIX_INDEX = 2;
    var indexInTable = CELL_PPREFIX_INDEX + index;
    
    document.getElementById("data").tHead.rows[0].deleteCell(indexInTable);
    
    var tableRows = document.getElementById("data").tBodies[0].rows;
    
    for (var i = 0; i < tableRows.length; i++) {
        tableRows[i].deleteCell(indexInTable);
	}
	
	save();
	calc();
}

</script>

</head>
<body>
<table id="data"><thead>
<tr>
    <th>Name</th>
    <th>Amount</th>
    <script  type="text/javascript" >
    for (ind in toppings) {
        document.write("<th>" + toppings[ind] + "</th>");
    }
    </script>
    <th>
        <button class="add" onclick="javascript:promptTopping()" alt="Add topping">+</button>
    </th>
</tr>
</thead>
<tbody>
   <script  type="text/javascript" >
    for (ind in names) {
        document.write("<tr class='tablerow'>" + createRow(names[ind]) + "</tr>");
    }
    </script>
</tbody>
<tfoot>
<tr>
<td>
<button class="add" onclick="javascript:promptName()" alt="Add name">+</button>
</td>
</tr>
</tfoot>
</table>
<!-- no need for button. everything is caluclated on change 
<button onclick="javascript:calc();">calc</button> 
-->

<div>
Results here:
<div id="results">
</div>
</div>

<script type="text/javascript" >
calc();
</script>

</body>

</html>
